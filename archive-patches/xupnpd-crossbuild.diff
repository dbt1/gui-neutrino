--- a/Makefile	2014-02-16 23:06:38.000000000 +0100
+++ b/Makefile	2014-02-16 23:08:41.000000000 +0100
@@ -2,7 +2,7 @@
 #LUA     = lua-5.2.0
 STATIC  = false
 
-CFLAGS  = -fno-exceptions -fno-rtti -O2 -I$(LUA) -L$(LUA)
+CFLAGS  = -fno-exceptions -fno-rtti -O2
 SRC     = main.cpp soap.cpp mem.cpp mcast.cpp luaxlib.cpp luaxcore.cpp luajson.cpp luajson_parser.cpp
 STAGING_DIR = /u01/home/shocker/staff/openwrt/staging_dir
 LUAMYCFLAGS = -DLUA_USE_LINUX
@@ -58,12 +58,9 @@
 
 
 embedded:
-	export PATH
-	export STAGING_DIR
-	make -C $(LUA) CC=$(SDK)/gcc a MYCFLAGS='$(LUAMYCFLAGS)'
-	$(SDK)/gcc -O2 -c -o md5.o md5c.c
-	$(SDK)/gcc $(CFLAGS) -DWITH_URANDOM -o xupnpd-$(TARGET) $(SRC) md5.o -llua -lm -ldl
-	$(SDK)/strip xupnpd-$(TARGET)
+	$(PREFIX)-gcc -O2 -c -o md5.o md5c.c
+	$(PREFIX)-gcc $(CFLAGS) $(LUAFLAGS) -DWITH_URANDOM -o xupnpd $(SRC) md5.o -llua -lm -ldl -rdynamic
+	$(PREFIX)-strip xupnpd
 
 clean:
 	make -C $(LUA) clean
